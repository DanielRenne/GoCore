
whoami=$(whoami)
if [[ "$whoami" == "root" ]]; then
    rm -rf /tmp/go-build* > /dev/null 2>&1
else
    sudo rm -rf /tmp/go-build* > /dev/null 2>&1
fi
bash $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/bin/kill_go_watch

if [ ! -f "$GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/webConfig.json" ]; then
    say "Copying web config and npm install for first time development process"
    mkdir -p $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/plugins
    cp $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/webConfig.dev.json $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/webConfig.json
    cd $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/bin
    chmod +x *
fi

nvm > /dev/null 2>&1
ret=$?
if [[ "$ret" -eq 0 ]]; then
  echo ""
else
  curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
  nvm install node
fi


if [ ! -d "$GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/web/app/node_modules" ]; then
    say "npm install starting"
    cd $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/web/app
    #https://github.com/sass/node-sass/issues/1847
    #node-sass needs unsafe-perm
    npm install --unsafe-perm
    say "npm install ended"
fi

if [ ! -f "$GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/web/app/dist/javascript/go-core-app.js.gz" ]; then
    say "copy dist tar balls starting"
    cd $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/web/app/javascript
    bash build.sh
    say "copy dist tar balls ending"
fi


echo "" > $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/app.log
echo "" > $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/db.log
echo "" > /tmp/go_watch.log
echo "" > $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/npm.log

if [[ "$whoami" == "root" ]]; then
    rm $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/mongo.log
else
    sudo rm $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/log/mongo.log
fi
bash $GOPATH/src/github.com/DanielRenne/goCoreAppTemplate/bin/dev
